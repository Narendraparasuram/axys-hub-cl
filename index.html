<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axys-hub</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app"></div>
    <script>
        const { createClient } = window.supabase;
        const sb = createClient('https://agxfjrqzevqjwvlkhzxz.supabase.co', 'sb_publishable_onnVe10I5QZpO9f2W3tuGg_uoORomht');
        
        let user = null, view = 'login', signup = false, tab = 'dashboard';
        let athletes = [], notes = [], messages = [], tasks = [];
        
        function code() { return Array.from({length:8}, () => 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'[Math.floor(Math.random()*36)]).join(''); }
        
        async function load() {
            if (!user) return;
            if (user.role === 'admin') ({ data: athletes } = await sb.from('athletes').select('*'));
            if (user.role === 'athlete') {
                const { data: a } = await sb.from('athletes').select('*').eq('email', user.email).single();
                if (a) athletes = [a];
                ({ data: notes } = await sb.from('notes').select('*').eq('athlete_id', a?.id));
                ({ data: messages } = await sb.from('messages').select('*').eq('athlete_id', a?.id));
                ({ data: tasks } = await sb.from('tasks').select('*').eq('athlete_id', a?.id));
            }
            if (user.role === 'professional') {
                const { data: tm } = await sb.from('team_members').select('*').eq('professional_id', user.id);
                const ids = tm?.map(t => t.athlete_id) || [];
                if (ids.length) ({ data: athletes } = await sb.from('athletes').select('*').in('id', ids));
            }
            render();
        }
        
        async function signup(e,p,n,r,s,c) {
            try {
                await sb.auth.signUp({email:e, password:p});
                const inv = r === 'athlete' ? code() : null;
                const { data: u } = await sb.from('users').insert([{email:e,password:p,name:n,role:r,invite_code:inv}]).select().single();
                if (r === 'athlete') await sb.from('athletes').insert([{user_id:u.id,name:n,sport:s,email:e,invite_code:inv}]);
                if (r === 'professional' && c) {
                    const { data: a } = await sb.from('athletes').select('*').eq('invite_code',c).single();
                    if (a) await sb.from('team_members').insert([{athlete_id:a.id,professional_id:u.id,professional_name:n}]);
                }
                alert('Created! Login now'); signup = false; render();
            } catch(err) { alert(err.message); }
        }
        
        async function login(e,p) {
            try {
                await sb.auth.signInWithPassword({email:e,password:p});
                const { data } = await sb.from('users').select('*').eq('email',e).single();
                user = data; view = 'dashboard'; await load();
            } catch(err) { alert(err.message); }
        }
        
        function render() {
            const app = document.getElementById('app');
            if (view === 'login' && !signup) {
                app.innerHTML = `<div class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                        <h1 class="text-4xl font-bold text-center mb-2">Axys-hub</h1>
                        <p class="text-center text-gray-600 mb-8">The central axis of athletic excellence</p>
                        <input id="e" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg mb-4">
                        <input id="p" type="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg mb-4">
                        <button onclick="login(document.getElementById('e').value, document.getElementById('p').value)" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 font-semibold mb-4">Sign In</button>
                        <button onclick="signup=true;render()" class="text-blue-500 hover:underline">Sign Up</button>
                    </div></div>`;
            } else if (signup) {
                app.innerHTML = `<div class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                        <h1 class="text-3xl font-bold text-center mb-6">Create Account</h1>
                        <input id="n" placeholder="Name" class="w-full px-4 py-2 border rounded-lg mb-4">
                        <input id="e" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg mb-4">
                        <input id="p" type="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg mb-4">
                        <select id="r" class="w-full px-4 py-2 border rounded-lg mb-4" onchange="document.getElementById('s').classList.toggle('hidden',this.value!=='athlete');document.getElementById('c').classList.toggle('hidden',this.value!=='professional')">
                            <option value="">Role</option><option value="athlete">Athlete</option><option value="professional">Professional</option><option value="admin">Admin</option>
                        </select>
                        <input id="s" placeholder="Sport" class="w-full px-4 py-2 border rounded-lg mb-4 hidden">
                        <input id="c" placeholder="Invite Code" class="w-full px-4 py-2 border rounded-lg mb-4 hidden">
                        <button onclick="signup(document.getElementById('e').value,document.getElementById('p').value,document.getElementById('n').value,document.getElementById('r').value,document.getElementById('s').value,document.getElementById('c').value)" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 font-semibold mb-4">Create</button>
                        <button onclick="signup=false;render()" class="text-blue-500 hover:underline">Sign In</button>
                    </div></div>`;
            } else {
                const a = user.role === 'athlete' ? athletes[0] : null;
                app.innerHTML = `<div class="min-h-screen bg-gray-100">
                    <div class="bg-white shadow-md"><div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                        <div><h1 class="text-2xl font-bold text-blue-600">Axys-hub</h1><p class="text-sm text-gray-600">${user.name} â€¢ ${user.role}</p></div>
                        <button onclick="sb.auth.signOut();user=null;view='login';render()" class="px-4 py-2 bg-red-500 text-white rounded-lg">Logout</button>
                    </div></div>
                    <div class="bg-white border-b"><div class="max-w-7xl mx-auto px-4 flex gap-8">
                        <button onclick="tab='dashboard';render()" class="py-4 border-b-2 ${tab==='dashboard'?'border-blue-500 text-blue-600':'border-transparent'}">Dashboard</button>
                        <button onclick="tab='notes';render()" class="py-4 border-b-2 ${tab==='notes'?'border-blue-500 text-blue-600':'border-transparent'}">Notes</button>
                        <button onclick="tab='messages';render()" class="py-4 border-b-2 ${tab==='messages'?'border-blue-500 text-blue-600':'border-transparent'}">Messages</button>
                        <button onclick="tab='tasks';render()" class="py-4 border-b-2 ${tab==='tasks'?'border-blue-500 text-blue-600':'border-transparent'}">Tasks</button>
                    </div></div>
                    <div class="max-w-7xl mx-auto p-8">
                        ${tab==='dashboard'?`<h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                        ${a?.invite_code?`<div class="bg-green-50 border-2 border-green-500 rounded-lg p-6 mb-6"><h3 class="text-xl font-bold mb-3">Your Invite Code</h3><p class="text-4xl font-mono font-bold text-green-600">${a.invite_code}</p><p class="mt-2 text-sm">Share with professionals</p></div>`:''}
                        <div class="grid grid-cols-4 gap-4">
                            <div class="bg-white p-6 rounded-lg shadow"><p class="text-gray-500">Athletes</p><p class="text-3xl font-bold">${athletes.length}</p></div>
                            <div class="bg-white p-6 rounded-lg shadow"><p class="text-gray-500">Notes</p><p class="text-3xl font-bold">${notes.length}</p></div>
                            <div class="bg-white p-6 rounded-lg shadow"><p class="text-gray-500">Messages</p><p class="text-3xl font-bold">${messages.length}</p></div>
                            <div class="bg-white p-6 rounded-lg shadow"><p class="text-gray-500">Tasks</p><p class="text-3xl font-bold">${tasks.length}</p></div>
                        </div>`:''}
                        ${tab==='notes'?`<h2 class="text-3xl font-bold mb-6">Notes</h2><div class="space-y-4">${notes.map(n=>`<div class="bg-white p-4 rounded-lg shadow"><div class="flex justify-between mb-2"><span class="font-bold">${n.category}</span><span class="text-sm text-gray-500">${n.date||'Today'}</span></div><p class="text-sm">${user.role==='athlete'?n.full_note:n.summary}</p><p class="text-xs text-gray-500 mt-2">- ${n.professional_name}</p></div>`).join('')||'<p class="text-gray-500">No notes</p>'}</div>`:''}
                        ${tab==='messages'?`<h2 class="text-3xl font-bold mb-6">Messages</h2><div class="space-y-4">${messages.map(m=>`<div class="bg-white p-4 rounded-lg shadow"><p class="font-bold">${m.from_user}</p><p>${m.message}</p></div>`).join('')||'<p class="text-gray-500">No messages</p>'}</div>`:''}
                        ${tab==='tasks'?`<h2 class="text-3xl font-bold mb-6">Tasks</h2><div class="space-y-4">${tasks.map(t=>`<div class="bg-white p-4 rounded-lg shadow"><p class="font-bold">${t.task}</p><p class="text-sm text-gray-600">For: ${t.athlete_name}</p><p class="text-xs text-gray-500">Due: ${t.due_date}</p></div>`).join('')||'<p class="text-gray-500">No tasks</p>'}</div>`:''}
                    </div>
                </div>`;
            }
        }
        render();
    </script>
</body>
</html>
